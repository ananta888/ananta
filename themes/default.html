<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Agent Controller Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f4f6f8; color: #333; }
    header { background: #007BFF; color: #fff; padding: 1em; text-align: center; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1em; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1em; margin-bottom: 2em; }
    .card { background: #fff; border-radius: 8px; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1); padding: 1em; transition: transform 0.3s; }
    .card:hover { transform: translateY(-5px); }
    .card.active { border: 2px solid #28a745; }
    h2 { border-bottom: 2px solid #007BFF; padding-bottom: 0.5em; }
    form { background: #fff; padding: 1em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2em; }
    label { display: block; margin-top: 1em; }
    input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 0.5em; margin-top: 0.5em; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 0.5em 1em; margin-top: 1em; background: #007BFF; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .output-pane { background: #e9ecef; padding: 1em; border-left: 4px solid #007BFF; position: fixed; top: 0; right: 0; width: 300px; height: 100%; overflow-y: auto; }
    @media (max-width: 768px) { .output-pane { position: static; width: 100%; } }
  </style>
  <script>
    function attachAjax(form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        fetch(form.action, { method: form.method, body: new FormData(form) })
        .then(response => response.text())
        .then(text => {
          const out = document.getElementById('output');
          out.textContent += (out.textContent ? "\\n" : "") + text;
        });
      });
    }
    window.addEventListener('load', function() {
      document.querySelectorAll('.ajax-form').forEach(attachAjax);
    });
  </script>
</head>
<body>
  <header>
    <h1>Agent Controller Dashboard</h1>
  </header>
  <div class="container">
    <section>
      <h2>Agenten</h2>
      <div class="grid">
        {% for name, cfg in agents_ordered %}
          <div class="card {% if name == active %}active{% endif %}">
            <h3>Rolle: {{ cfg.get('role', name) }}</h3>
            <p><strong>Modell:</strong> {{ cfg['model'] }}<br/>
            <strong>Anbieter:</strong> {{ cfg['provider'] }}</p>
            {% if cfg.get('purpose') %}
              <p>Zweck: {{ cfg['purpose'] }}</p>
            {% endif %}
            {% if cfg.get('preferred_hardware') %}
              <p>Bevorzugte Hardware: {{ cfg['preferred_hardware'] }}</p>
            {% endif %}
            <form method="post">
              <input type="hidden" name="set_active" value="{{ name }}"/>
              <button type="submit">Aktivieren</button>
            </form>
          </div>
        {% endfor %}
      </div>
      <form method="post">
        <input type="text" name="new_agent" placeholder="Neuer Agent"/>
        <button type="submit">Agent hinzuf√ºgen</button>
      </form>
    </section>

    <section>
      <h2>üîÄ Pipeline Order</h2>
      <ol>
        {% for agent in pipeline_order %}
          <li>{{ agent }}</li>
        {% endfor %}
      </ol>
      <div>
        {% for agent in pipeline_order %}
          <form method="post" style="display:inline">
            <input type="hidden" name="move_agent" value="{{ agent }}"/>
            <input type="hidden" name="direction" value="up"/>
            <button type="submit">‚¨ÜÔ∏è {{ agent }}</button>
          </form>
          <form method="post" style="display:inline">
            <input type="hidden" name="move_agent" value="{{ agent }}"/>
            <input type="hidden" name="direction" value="down"/>
            <button type="submit">‚¨áÔ∏è {{ agent }}</button>
          </form>
          <br/>
        {% endfor %}
      </div>
    </section>

    <section>
      <h2>Aufgaben</h2>
      <ul>
        {% for t in config.get('tasks', []) %}
          <li>
            {{ t['task'] }} - {{ t['agent'] or 'auto' }}
            <form method="post" style="display:inline">
              <button name="task_delete_{{ loop.index0 }}" value="1" type="submit">üóë L√∂schen</button>
            </form>
          </li>
        {% endfor %}
      </ul>
      <form method="post">
        <input type="text" name="task_text" placeholder="Neue Aufgabe"/>
        <select name="task_agent">
          <option value="">Automatisch</option>
          {% for name in config['agents'].keys() %}
            <option value="{{ name }}">{{ name }}</option>
          {% endfor %}
        </select>
        <button name="add_task" value="1" type="submit">Aufgabe hinzuf√ºgen</button>
      </form>
    </section>

    <section>
      <h2>Einstellungen f√ºr Agent: {{ active }}</h2>
      <form method="post">
        <input type="hidden" name="agent" value="{{ active }}"/>
        {% for key, val in agent_cfg.items() if key != 'tasks' %}
          <label for="{{ key }}">{{ key }}:</label>
          {% if key in boolean_fields %}
            <select name="{{ key }}" id="{{ key }}">
              <option value="True" {% if val %}selected{% endif %}>True</option>
              <option value="False" {% if not val %}selected{% endif %}>False</option>
            </select>
          {% elif key == 'provider' %}
            <select name="provider" id="{{ key }}">
              {% for option in providers %}
                <option value="{{ option }}" {% if val == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          {% elif key == 'template' %}
            <select name="template" id="{{ key }}">
              {% for tname in config['prompt_templates'].keys() %}
                <option value="{{ tname }}" {% if val == tname %}selected{% endif %}>{{ tname }}</option>
              {% endfor %}
            </select>
          {% else %}
            <input type="text" name="{{ key }}" id="{{ key }}" value="{{ val }}" />
          {% endif %}
        {% endfor %}
        <label for="tasks">Aufgaben (jeweils in neuer Zeile):</label>
        <textarea name="tasks" id="tasks">{{ agent_cfg['tasks']|join('\n') }}</textarea>
        <button type="submit">√Ñnderungen speichern</button>
      </form>
    </section>

    <section>
      <h2>API Endpoints</h2>
      <form method="post">
        <input type="hidden" name="api_endpoints_form" value="1" />
        {% for ep in config['api_endpoints'] %}
          <div style="margin-bottom:1em;">
            <select name="endpoint_type_{{ loop.index0 }}">
              {% for option in providers %}
                <option value="{{ option }}" {% if ep['type'] == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
            <input type="text" name="endpoint_url_{{ loop.index0 }}" value="{{ ep['url'] }}" />
            <button name="endpoint_delete_{{ loop.index0 }}" value="1" type="submit">L√∂schen</button>
          </div>
        {% endfor %}
        <div style="margin-bottom:1em;">
          <select name="new_endpoint_type">
            {% for option in providers %}
              <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
          </select>
          <input type="text" name="new_endpoint_url" placeholder="Neue URL" />
          <button name="add_endpoint" value="1" type="submit">Hinzuf√ºgen</button>
        </div>
        <button type="submit">API Endpoints speichern</button>
      </form>
    </section>

    <section>
      <h2>Prompt Vorlagen</h2>
      <form method="post">
        <textarea name="prompt_templates" style="width:100%; height:150px;">
{{ config['prompt_templates']|tojson(indent=2) }}
        </textarea>
        <button type="submit">Prompt Vorlagen speichern</button>
      </form>
    </section>

    <section>
      <h2>Protokolle & Zusammenfassung</h2>
      <div style="display: flex; gap: 1em;">
        <div style="flex: 1;">
          <h3>Zusammenfassung</h3>
          <pre>{{ summary }}</pre>
        </div>
        <div style="flex: 1;">
          <h3>Letzter Log</h3>
          <pre>{{ log }}</pre>
        </div>
      </div>
    </section>

    <section>
      <h2>Agent Steuerung</h2>
      <form method="post" action="/stop" class="ajax-form" style="display:inline-block;">
        <button type="submit">Agent stoppen</button>
      </form>
      <form method="post" action="/restart" class="ajax-form" style="display:inline-block;">
        <button type="submit">Agent neu starten</button>
      </form>
      <a href="/export"><button type="button">Logs exportieren</button></a>
    </section>
    <section>
        <h2>Theme ausw√§hlen</h2>
        <form method="post" action="/set_theme">
            <select name="theme">
                {% for theme in available_themes %}
                    <option value="{{ theme }}" {% if theme == current_theme %}selected{% endif %}>{{ theme }}</option>
                {% endfor %}
            </select>
            <button type="submit">Theme √§ndern</button>
        </form>
    </section>
  </div>
  <div id="output" class="output-pane"></div>
</body>
</html>