version: "3.8"

services:
  controller:
    build:
      context: .
      dockerfile: Dockerfile
      target: controller
    image: ananta-controller:latest
    ports:
      - "8081:8081"
    depends_on:
        db:
          condition: service_healthy
    environment:
      - AI_AGENT_URL=http://ai-agent:5000
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/ananta
      - RUN_TESTS=false # Setze auf 'true', um Tests auszuführen
      - PLAYWRIGHT_BASE_URL=http://controller:8081
      - PLAYWRIGHT_SKIP_WEBSERVER=1
      - NODE_ENV=production
      - FLASK_ENV=production
      - PATH=/app/frontend/node_modules/.bin:${PATH}
    volumes:
      - ./:/app        # <–– alles aus Deinem Projektordner
      - /app/frontend/node_modules  # <-- node_modules vom Container-Dateisystem verwenden
      - /app/frontend/dist  # <-- dist vom Container-Dateisystem verwenden
    extra_hosts:
      - "host.docker.internal:host-gateway"
    entrypoint: ["/bin/bash", "-c", "mkdir -p /app/frontend/node_modules && mkdir -p /app/frontend/dist && chmod -R 777 /app/frontend/dist && cd frontend && npm install --unsafe-perm --no-bin-links && npm run build && if [ \"$RUN_TESTS\" = \"true\" ]; then npm install -D @playwright/test && npx playwright install --with-deps && NODE_OPTIONS=\"--experimental-vm-modules\" npx playwright test; fi && cd .. && exec python -m controller.controller"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  ai-agent:
    build:
      context: .
      dockerfile: Dockerfile
      target: ai-agent
    image: ananta-agent:latest
    depends_on:
      db:
        condition: service_healthy
      controller:
        condition: service_started
    ports:
      - "5000:5000"
    environment:
      - CONTROLLER_URL=http://controller:8081
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/ananta
      - AI_AGENT_LOG_LEVEL=DEBUG
    volumes:
      - ./:/app        # <–– Host-Code mounten
    extra_hosts:
      - "host.docker.internal:host-gateway"
    entrypoint: ["/bin/bash", "-c", "sed -i 's/\r$//' /app/entrypoint-ai-agent.sh && chmod +x /app/entrypoint-ai-agent.sh && /app/entrypoint-ai-agent.sh"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  db:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: ananta
    ports:
      - "5432:5432"
    volumes:
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s


  playwright:
    build:
      context: .
      dockerfile: Dockerfile
      target: playwright
    image: ananta-playwright:latest
    depends_on:
      controller:
        condition: service_healthy
      ai-agent:
        condition: service_healthy
      db:
        condition: service_started
    environment:
      - BACKEND_URL=http://controller:8081
      - AGENT_URL=http://ai-agent:5000
      - PLAYWRIGHT_BASE_URL=http://controller:8081
      - PLAYWRIGHT_SKIP_WEBSERVER=1
      - CI=1
      - PLAYWRIGHT_TIMEOUT=120000 # Erhöhtes Timeout
      - PLAYWRIGHT_GLOBAL_TIMEOUT=180000 # Maximale Testlaufzeit
      - DEBUG=pw:api,pw:browser  # Erweitertes Debugging
      - XVFB_DISPLAY=:99  # X Virtual Framebuffer für headless-Tests
      - NODE_ENV=test
    volumes:
      - ./:/app
      - /app/frontend/node_modules
      - /app/frontend/dist
    working_dir: /app/frontend
    # Verbesserte Überprüfung und Debugging vor dem Ausführen der Tests
    entrypoint: >
      /bin/bash -c "echo 'Warte auf vollständiges Hochfahren der Services...' &&
             sleep 10 &&
             echo 'Prüfe Verbindung zum Controller...' &&
             curl -v http://controller:8081/health &&
             echo 'Prüfe Verbindung zum AI-Agent...' &&
             curl -v http://ai-agent:5000/health &&
             echo 'Teste Zugriff auf Frontend...' &&
             curl -v http://controller:8081/ui/ &&
             echo 'Prüfe API-Endpunkte...' &&
             curl -v http://controller:8081/config &&
             echo 'Starte Playwright-Tests...' &&
             sleep 5 &&
             /app/run-tests.sh"
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  db_data:
